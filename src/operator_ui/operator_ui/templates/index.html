<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>ASV Operator Console</title>

  <!-- Leaflet (карта) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- ROSLIB -->
  <script src="https://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 0; }
    header { background:#0d6efd; color:#fff; padding:8px 16px; }
    header h2 { margin:0; font-size:1.2rem; display:inline-block; }
    #status { font-weight:bold; }
    #map { height: 75vh; }
    #sidebar { padding:10px 16px; }
    button { margin:4px; padding:6px 12px; border:0; border-radius:6px; cursor:pointer; }
    .primary { background:#0d6efd; color:#fff; }
    .danger  { background:#dc3545; color:#fff; }
  </style>
</head>
<body>
  <header>
    <h2>ASV Operator Console</h2>
    &nbsp;|&nbsp;ROS&nbsp;<span id="status">Disconnected</span> |
    Mode: <span id="mode">–</span>
  </header>

  <div id="map"></div>

  <div id="sidebar">
    <button class="primary" onclick="toggleAuto()">Toggle&nbsp;Auto/Manual</button>
    <button class="primary" onclick="returnHome()">Return&nbsp;Home</button>
    <button class="danger"  onclick="clearPath()">Clear&nbsp;Path</button>
    <p>Щёлкните по карте — отправите waypoint в ИИ-планер.</p>
  </div>

<script>
/* ---------- ROS connection ---------- */
const ros = new ROSLIB.Ros({ url: 'ws://'+location.hostname+':9090' });

ros.on('connection', () =>  document.getElementById('status').textContent='Connected' );
ros.on('close',      () =>  document.getElementById('status').textContent='Closed'    );
ros.on('error',      () =>  document.getElementById('status').textContent='Error'     );

/* Publishers / subscribers */
const overridePub   = new ROSLIB.Topic({ ros, name:'/override',          messageType:'std_msgs/Bool' });
const waypointPub   = new ROSLIB.Topic({ ros, name:'/desired_waypoint',  messageType:'geometry_msgs/Point' });
const returnHomePub = new ROSLIB.Topic({ ros, name:'/return_home',       messageType:'std_msgs/Empty' });

ros.subscribe('/current_mode', 'std_msgs/String', msg =>
  document.getElementById('mode').textContent = msg.data);

/* ---------- Leaflet map ---------- */
const map = L.map('map', { crs:L.CRS.Simple, minZoom:-2 });
const bounds = [[-50,-50],[50,50]];                      // виртуальные метры
const image  = L.rectangle(bounds, {opacity:0.0}).addTo(map); // прозрачный слой
map.fitBounds(bounds);

let track = L.polyline([], {weight:3}).addTo(map);
let marker = L.marker([0,0]).addTo(map);

/* click-to-set waypoint */
map.on('click', e=>{
  const {lat, lng} = e.latlng;
  waypointPub.publish({x:lng, y:lat, z:0});
  L.circleMarker([lat,lng], {radius:4, color:'#0d6efd'}).addTo(map);
});

/* ---------- Update boat pose ---------- */
ros.subscribe('/odom', 'nav_msgs/Odometry', msg=>{
  const x = msg.pose.pose.position.x;
  const y = msg.pose.pose.position.y;
  marker.setLatLng([y,x]);
  track.addLatLng([y,x]);
});

/* ---------- UI buttons ---------- */
function toggleAuto(){  overridePub.publish({data:true}); }
function returnHome(){  returnHomePub.publish({}); }
function clearPath(){   track.setLatLngs([]); }

</script>
</body>
</html>
